{% extends "base.html" %}
{% block title %}Reportes - Admin{% endblock %}

{% block content %}
<h1 class="text-white mb-4"><i class="bi bi-graph-up"></i> Reportes y An√°lisis BI</h1>

<!-- Selector de Reporte -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-list-check"></i> Selecciona un Reporte</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100" onclick="cargarReporte('salas_mas_reservadas')">
                    <i class="bi bi-building"></i> Salas M√°s Reservadas
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100" onclick="cargarReporte('turnos_demandados')">
                    <i class="bi bi-clock"></i> Turnos M√°s Demandados
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100" onclick="cargarReporte('promedio_participantes')">
                    <i class="bi bi-people"></i> Promedio Participantes/Sala
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-success w-100" onclick="cargarReporte('reservas_por_carrera')">
                    <i class="bi bi-mortarboard"></i> Reservas por Carrera
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-success w-100" onclick="cargarReporte('ocupacion_edificio')">
                    <i class="bi bi-building-fill"></i> Ocupaci√≥n por Edificio
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-success w-100" onclick="cargarReporte('reservas_por_tipo')">
                    <i class="bi bi-person-badge"></i> Reservas por Tipo Usuario
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-warning w-100" onclick="cargarReporte('sanciones_por_tipo')">
                    <i class="bi bi-exclamation-triangle"></i> Sanciones por Tipo
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-warning w-100" onclick="cargarReporte('efectividad')">
                    <i class="bi bi-pie-chart"></i> Efectividad de Reservas
                </button>
            </div>
            
            <div class="col-md-4">
                <button class="btn btn-outline-info w-100" onclick="cargarReporte('horas_semana')">
                    <i class="bi bi-calendar-week"></i> Horas por Semana
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-info w-100" onclick="cargarReporte('participantes_sancionados')">
                    <i class="bi bi-person-x"></i> M√°s Sancionados
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-info w-100" onclick="cargarReporte('edificios_cancelaciones')">
                    <i class="bi bi-x-circle"></i> Cancelaciones/Edificio
                </button>
            </div>
        </div>
    </div>
</div>

<!-- √Årea de Visualizaci√≥n -->
<div id="reporte-container" class="card" style="display:none;">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0" id="reporte-titulo">Reporte</h5>
    </div>
    <div class="card-body">
        <div id="reporte-grafico"></div>
        <hr>
        <div id="reporte-tabla" class="table-responsive"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartActual = null;

const reportes = {
    'salas_mas_reservadas': {
        titulo: 'üìä Salas M√°s Reservadas',
        tipo: 'bar',
        api: '/admin/reportes/salas_mas_reservadas'
    },
    'turnos_demandados': {
        titulo: '‚è∞ Turnos M√°s Demandados',
        tipo: 'line',
        api: '/admin/reportes/turnos_demandados'
    },
    'promedio_participantes': {
        titulo: 'üë• Promedio de Participantes por Sala',
        tipo: 'bar',
        api: '/admin/reportes/promedio_participantes'
    },
    'reservas_por_carrera': {
        titulo: 'üéì Reservas por Carrera y Facultad',
        tipo: 'tabla',
        api: '/admin/reportes/reservas_por_carrera'
    },
    'ocupacion_edificio': {
        titulo: 'üè¢ Porcentaje de Ocupaci√≥n por Edificio',
        tipo: 'bar',
        api: '/admin/reportes/ocupacion_edificio'
    },
    'reservas_por_tipo': {
        titulo: 'üë§ Reservas y Asistencias por Tipo de Usuario',
        tipo: 'tabla',
        api: '/admin/reportes/reservas_por_tipo'
    },
    'sanciones_por_tipo': {
        titulo: '‚ö†Ô∏è Sanciones por Tipo de Usuario',
        tipo: 'pie',
        api: '/admin/reportes/sanciones_por_tipo'
    },
    'efectividad': {
        titulo: 'üìà Efectividad de Reservas',
        tipo: 'pie',
        api: '/admin/reportes/efectividad'
    },
    'horas_semana': {
        titulo: 'üìÖ Horas Reservadas por Semana',
        tipo: 'line',
        api: '/admin/reportes/horas_semana'
    },
    'participantes_sancionados': {
        titulo: 'üö´ Participantes M√°s Sancionados',
        tipo: 'tabla',
        api: '/admin/reportes/participantes_sancionados'
    },
    'edificios_cancelaciones': {
        titulo: '‚ùå Edificios con M√°s Cancelaciones',
        tipo: 'tabla',
        api: '/admin/reportes/edificios_cancelaciones'
    }
};

function cargarReporte(tipo) {
    const config = reportes[tipo];
    if (!config) {
        alert('Reporte no encontrado: ' + tipo);
        return;
    }
    
    document.getElementById('reporte-titulo').textContent = config.titulo;
    document.getElementById('reporte-container').style.display = 'block';
    
    fetch(config.api)
        .then(res => {
            if (!res.ok) {
                throw new Error('Error HTTP: ' + res.status);
            }
            return res.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
            console.log('Tipo de dato:', typeof data);
            console.log('Es array?', Array.isArray(data));
            
            if (!Array.isArray(data)) {
                throw new Error('Los datos recibidos no son un array');
            }
            
            if (config.tipo === 'tabla') {
                mostrarTabla(data, tipo);
            } else {
                mostrarGrafico(data, tipo, config.tipo);
            }
        })
        .catch(err => {
            console.error('Error completo:', err);
            alert('Error al cargar reporte: ' + err.message);
        });
}

function mostrarGrafico(data, tipo, tipoGrafico) {
    document.getElementById('reporte-grafico').innerHTML = '<canvas id="chart"></canvas>';
    document.getElementById('reporte-tabla').innerHTML = '';
    
    if (chartActual) {
        chartActual.destroy();
    }
    
    let config = {};
    
    if (tipo === 'salas_mas_reservadas') {
        config = {
            type: tipoGrafico,
            data: {
                labels: data.map(d => d.nombre_sala + ' (' + d.edificio + ')'),
                datasets: [{
                    label: 'Total Reservas',
                    data: data.map(d => d.total_reservas),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top 10 Salas M√°s Reservadas'
                    }
                }
            }
        };
    } else if (tipo === 'turnos_demandados') {
        config = {
            type: tipoGrafico,
            data: {
                labels: data.map(d => d.horario),
                datasets: [{
                    label: 'Reservas',
                    data: data.map(d => d.total_reservas),
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Demanda por Turno'
                    }
                }
            }
        };
    } else if (tipo === 'promedio_participantes') {
        config = {
            type: tipoGrafico,
            data: {
                labels: data.map(d => d.nombre_sala + ' (' + d.edificio + ')'),
                datasets: [{
                    label: 'Promedio Participantes',
                    data: data.map(d => parseFloat(d.promedio_participantes) || 0),
                    backgroundColor: 'rgba(153, 102, 255, 0.8)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Ocupaci√≥n Promedio por Sala'
                    }
                }
            }
        };
    } else if (tipo === 'ocupacion_edificio') {
        config = {
            type: tipoGrafico,
            data: {
                labels: data.map(d => d.nombre_edificio),
                datasets: [{
                    label: '% Ocupaci√≥n',
                    data: data.map(d => parseFloat(d.porcentaje_ocupacion) || 0),
                    backgroundColor: 'rgba(255, 159, 64, 0.8)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Porcentaje de Ocupaci√≥n por Edificio (√∫ltimos 30 d√≠as)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        };
    } else if (tipo === 'sanciones_por_tipo') {
        config = {
            type: tipoGrafico,
            data: {
                labels: data.map(d => d.tipo_usuario),
                datasets: [{
                    label: 'Sanciones',
                    data: data.map(d => d.total_sanciones),
                    backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribuci√≥n de Sanciones por Tipo de Usuario'
                    }
                }
            }
        };
    } else if (tipo === 'efectividad') {
        config = {
            type: tipoGrafico,
            data: {
                labels: data.map(d => d.estado),
                datasets: [{
                    data: data.map(d => d.total),
                    backgroundColor: ['#28a745', '#dc3545', '#6c757d', '#ffc107']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Estado de Reservas'
                    }
                }
            }
        };
    } else if (tipo === 'horas_semana') {
        config = {
            type: tipoGrafico,
            data: {
                labels: data.map(d => 'Semana ' + d.num_semana),
                datasets: [{
                    label: 'Horas Reservadas',
                    data: data.map(d => d.total_horas_reservadas),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Tendencia de Reservas (√∫ltimas 8 semanas)'
                    }
                }
            }
        };
    }
    
    chartActual = new Chart(document.getElementById('chart'), config);
}

function mostrarTabla(data, tipo) {
    document.getElementById('reporte-grafico').innerHTML = '';
    let html = '<table class="table table-striped table-hover"><thead class="table-dark"><tr>';
    
    if (tipo === 'reservas_por_carrera') {
        html += '<th>Facultad</th><th>Programa</th><th>Tipo</th><th>Total Reservas</th>';
        html += '</tr></thead><tbody>';
        data.forEach(d => {
            html += `<tr>
                <td>${d.facultad}</td>
                <td>${d.nombre_programa}</td>
                <td><span class="badge bg-secondary">${d.tipo_programa}</span></td>
                <td><span class="badge bg-primary">${d.total_reservas}</span></td>
            </tr>`;
        });
    } else if (tipo === 'reservas_por_tipo') {
        html += '<th>Tipo Usuario</th><th>Total Usuarios</th><th>Total Reservas</th><th>Asistencias</th><th>Inasistencias</th><th>% Asistencia</th>';
        html += '</tr></thead><tbody>';
        data.forEach(d => {
            html += `<tr>
                <td><strong>${d.tipo_usuario}</strong></td>
                <td>${d.total_usuarios}</td>
                <td>${d.total_reservas}</td>
                <td><span class="badge bg-success">${d.total_asistencias}</span></td>
                <td><span class="badge bg-warning">${d.total_inasistencias}</span></td>
                <td><span class="badge bg-info">${d.porcentaje_asistencia}%</span></td>
            </tr>`;
        });
    } else if (tipo === 'participantes_sancionados') {
        html += '<th>CI</th><th>Nombre Completo</th><th>Email</th><th>Total Sanciones</th><th>Sanciones Activas</th>';
        html += '</tr></thead><tbody>';
        data.forEach(d => {
            html += `<tr>
                <td>${d.ci}</td>
                <td>${d.nombre} ${d.apellido}</td>
                <td><small>${d.email}</small></td>
                <td><span class="badge bg-danger">${d.total_sanciones}</span></td>
                <td><span class="badge bg-warning">${d.sanciones_activas}</span></td>
            </tr>`;
        });
    } else if (tipo === 'edificios_cancelaciones') {
        html += '<th>Edificio</th><th>Direcci√≥n</th><th>Total Reservas</th><th>Canceladas</th><th>Sin Asistencia</th><th>% Cancelaci√≥n</th><th>% Problem√°ticas</th>';
        html += '</tr></thead><tbody>';
        data.forEach(d => {
            const colorPct = d.porcentaje_cancelacion > 20 ? 'danger' : (d.porcentaje_cancelacion > 10 ? 'warning' : 'success');
            html += `<tr>
                <td><strong>${d.nombre_edificio}</strong></td>
                <td><small>${d.direccion}</small></td>
                <td>${d.total_reservas}</td>
                <td><span class="badge bg-danger">${d.total_canceladas}</span></td>
                <td><span class="badge bg-warning">${d.total_sin_asistencia}</span></td>
                <td><span class="badge bg-${colorPct}">${d.porcentaje_cancelacion}%</span></td>
                <td><span class="badge bg-dark">${d.porcentaje_problematicas}%</span></td>
            </tr>`;
        });
    }
    
    html += '</tbody></table>';
    document.getElementById('reporte-tabla').innerHTML = html;
}
</script>
{% endblock %}